# code: language=yaml
#
# Flow Logs (Step 9)
# Creates VPC Flow Logs for network traffic monitoring
# Depends on: $state.network
#

{{- if $state.network.flowLogs.render }}
---
apiVersion: ec2.aws.m.upbound.io/v1beta1
kind: FlowLog
metadata:
  name: {{ $state.network.name }}-flow-log
  annotations:
    {{ setResourceNameAnnotation "flow-log" }}
  labels:
    hops.ops.com.ai/network: {{ $state.network.name }}
spec:
  managementPolicies: {{ $state.network.managementPolicies | toJson }}
  forProvider:
    region: {{ $state.network.region }}
    vpcIdRef:
      name: {{ $state.network.name }}
    trafficType: {{ $state.network.flowLogs.trafficType }}
    {{- if eq $state.network.flowLogs.destination "cloudwatch" }}
    logDestinationType: cloud-watch-logs
    logDestination: {{ $state.network.flowLogs.destinationArn }}
    {{- if $state.network.flowLogs.iamRoleArn }}
    iamRoleArn: {{ $state.network.flowLogs.iamRoleArn }}
    {{- end }}
    {{- else if eq $state.network.flowLogs.destination "s3" }}
    logDestinationType: s3
    logDestination: {{ $state.network.flowLogs.destinationArn }}
    {{- end }}
    tags:
      {{ $state.network.tags | toYaml | nindent 6 }}
      Name: {{ $state.network.name }}-flow-log
  providerConfigRef:
    name: {{ $state.network.providerConfig.name }}
    kind: {{ $state.network.providerConfig.kind }}
{{- end }}

